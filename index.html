<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Layout Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #status { margin-bottom: 10px; font-weight: bold; }
        #roomLayout {
            position: absolute;
            width: 321px;
            height: 251px;
            border: 2px solid #333;
            background-color: #f0f0f0;
        }
        .dot {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: red;
            border-radius: 50%;
        }
        #room-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin-top: 20px;
        }
        #room-layout {
            width: 100%;
            height: auto;
            border: 2px solid #333;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .state-label {
            position: absolute;
            color: blue;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            transform: translate(-50%, -50%);
        }
        .message-box {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(173, 216, 230, 0.9);
            padding: 10px;
            border-radius: 5px;
            color: blue;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #333;
        }
        .message-box table {
            width: 100%;
            border-collapse: collapse;
        }
        .message-box td {
            padding: 2px 5px;
        }
        #test-controls {
            margin-top: 20px;
        }
        #test-message {
            width: 80%;
            height: 100px;
        }
        #test-button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #test-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

    <!-- Alert: changed Version when edited -->
    <h2>Joybien Technologies DASHBOARD V01.59</h2>
    
    <p id="status">Status: Disconnected</p>

    <!-- Room Bed Layout -->    
    <h2>Room Bed Layout</h2>
    <div id="room-container">
        <img id="room-layout" src="./assets/jb_room_layout_321x251.jpg" alt="Room Layout">
        <div id="overlay"></div>
    </div>

    <!-- Test Controls -->
    <div id="test-controls">
        <h3>Test Message Publisher</h3>
        <textarea id="test-message">{"time":"2025/02/06-17:15:19", "sn":"sn00001c", "location":"room 1002", "fn":278921, "pts_center":[[0.55, 0.82, 1.64]], "state":"SIT"}</textarea>
        <br>
        <button id="test-button" onclick="jb_pub_test_message()">TEST</button>
    </div>

    <script>
        // (1) Connect to the MQTT broker
        console.log("(1) Connect to wss://59.124.7.95/mqtt");
        const client = mqtt.connect("wss://59.124.7.95/mqtt");
        console.log("(1) OK! Connected");

        // (2) Connection status updates
        client.on("connect", () => {
            document.getElementById("status").innerText = "Status: Connected";
            client.subscribe("bed", (err) => {
                if (!err) {
                    console.log("(2) Subscribed to topic: bed");
                    console.log("(2) OK! Subscribed");
                } else {
                    console.error("(2_error) Subscription error:", err);
                }
            });
        });

        // (3) on “message” case
        client.on("message", (topic, message) => {
            if (topic == "bed") {
                console.log('(3) Received Message, Bytes => String => Data_Structure see followings,')
                console.log(message)
                console.log(message.toString())
                const data = JSON.parse(message.toString());
                console.log(data)
                console.log(data.pts_center)
                updateRoomLayout(data.pts_center);
                jb_show_state(data.state);
                jb_show_message(data);
            }
        });     

        // simple map function
        function jb_map(x, x1, x2, y1, y2) {
            return (y2 - y1) / (x2 - x1) * (x - x1) + y1; 
        }

        function updateRoomLayout(locations) {
            const overlay = document.getElementById("overlay");
            overlay.innerHTML = ''; // Clear previous dots
        
            // Define real-world coordinate bounds
            const x_min = -2, x_max = 2;  // Real-world x range
            const y_min = 0, y_max = 4;   // Real-world y range
        
            // Force overlay to match image dimensions
            overlay.style.width = "321px";
            overlay.style.height = "251px";
        
            const dotSize = 10; // Size of the dot
        
            locations.forEach(coord => {
                const [x, y] = coord;
        
                // Convert real-world coordinates to pixel coordinates
                const x_px = jb_map(x, x_min, x_max, 0, 400);
                const y_px = jb_map(y, y_min, y_max, 320, 0);
        
                // Create and position the dot, adjusting for dot size
                const dot = document.createElement("div");
                dot.className = "dot";
                dot.style.left = `${x_px - dotSize / 2}px`;  // Center the dot horizontally
                dot.style.top = `${y_px - dotSize / 2}px`;   // Center the dot vertically
        
                // Log for debugging
                console.log(`\"loc_px\": [${Math.round(x_px)}, ${Math.round(y_px)}], \"x, y\": [${x}, ${y}]`);
        
                overlay.appendChild(dot);
            });
        }

        // Function to show state in the center of the room layout
        function jb_show_state(state) {
            const overlay = document.getElementById("overlay");
            const stateLabel = document.createElement("div");
            stateLabel.className = "state-label";
            stateLabel.innerText = state;

            // Position the label at the center of the layout
            stateLabel.style.left = '50%';
            stateLabel.style.top = '50%';

            overlay.appendChild(stateLabel);
        }

        // Function to show key-value message in the top-left corner
        function jb_show_message(data) {
            const overlay = document.getElementById("overlay");
            const messageBox = document.createElement("div");
            messageBox.className = "message-box";

            const table = document.createElement("table");
            
            for (const [key, value] of Object.entries(data)) {
                const row = document.createElement("tr");
                const keyCell = document.createElement("td");
                const valueCell = document.createElement("td");

                keyCell.innerText = key;
                valueCell.innerText = Array.isArray(value) ? value.join(", ") : value;

                row.appendChild(keyCell);
                row.appendChild(valueCell);
                table.appendChild(row);
            }

            messageBox.appendChild(table);
            overlay.appendChild(messageBox);
        }

        // Function to publish a test message
        function jb_pub_test_message() {
            const messageField = document.getElementById("test-message");
            const message = messageField.value;
            try {
                const parsedMessage = JSON.parse(message);
                client.publish("bed", JSON.stringify(parsedMessage));
                console.log("(TEST) Published message:", parsedMessage);
            } catch (error) {
                console.error("Invalid JSON format:", error);
            }
        }

        // (5) on “error” case
        client.on("error", (error) => {
            console.error("Connection Error:", error);
            document.getElementById("status").innerText = "Status: Connection Error";
        });

        // (6) on “close” case
        client.on("close", () => {
            document.getElementById("status").innerText = "Status: Disconnected";
        });
    </script>

</body>
</html>
