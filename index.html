 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Layout Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #status { margin-bottom: 10px; font-weight: bold; }
        #roomLayout {
            position: relative;
            width: 400px;
            height: 400px;
            border: 2px solid #333;
            background-color: #f0f0f0;
        }
        .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
        }
        #room-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin-top: 20px;
        }
        #room-layout {
            width: 100%;
            height: auto;
            border: 2px solid #333;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .state-label {
            position: absolute;
            color: blue;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <h2>Room Layout Dashboard V01.54</h2>
    <p id="status">Status: Disconnected</p>

    <div id="roomLayout"></div>

    <!-- Room Bed Layout -->    
    <h2>Room Bed Layout</h2>
    <div id="room-container">
        <img id="room-layout" src="./assets/jb_room_layout_321x251.jpg" alt="Room Layout">
        <div id="overlay"></div>
    </div>

    <script>
        // (1) Connect to the MQTT broker
        const client = mqtt.connect("wss://59.124.7.95/mqtt");

        // (2) Connection status updates
        client.on("connect", () => {
            document.getElementById("status").innerText = "Status: Connected";
            client.subscribe("bed", (err) => {
                if (!err) {
                    console.log("Subscribed to topic: bed");
                } else {
                    console.error("Subscription error:", err);
                }
            });
        });

        // (3) on “error” case
        client.on("error", (error) => {
            console.error("Connection Error:", error);
            document.getElementById("status").innerText = "Status: Connection Error";
        });

        // (4) on “close” case
        client.on("close", () => {
            document.getElementById("status").innerText = "Status: Disconnected";
        });

        // (5) on “message” case
        // Handle incoming messages and display on layout
        client.on("message", (topic, message) => {
            if (topic === "bed") {
                const data = JSON.parse(message.toString());
                updateRoomLayout(data.pts_center);
                jb_show_state(data.state);
            }
        });

        // (6) on “update layout by x y ” case

        // Function to update the room layout with new coordinates
        function updateRoomLayout(locations) {
            const overlay = document.getElementById("overlay");
            overlay.innerHTML = ''; // Clear previous dots

            // Define real-world coordinate bounds
            const x_min = -2, x_max = 2;  // Real-world x range
            const y_min = 0, y_max = 4;   // Real-world y range

            // Force overlay to match image dimensions
            overlay.style.width = "321px";
            overlay.style.height = "251px";

            const dotSize = 10; // Size of the dot

            locations.forEach(coord => {
                const [x, y] = coord;

                // Convert real-world coordinates to pixel coordinates
                const x_px = jb_map(x, x_min, x_max, 0, 321);
                const y_px = jb_map(y, y_min, y_max, 251, 0);

                // Create and position the dot, adjusting for dot size
                const dot = document.createElement("div");
                dot.className = "dot";
                dot.style.left = `${x_px - dotSize / 2}px`;
                dot.style.top = `${y_px - dotSize / 2}px`;

                overlay.appendChild(dot);
            });
        }

        // Simple map function
        function jb_map(x, x1, x2, y1, y2) {
            return (y2 - y1) / (x2 - x1) * (x - x1) + y1; 
        }

        // Function to show state in the center of the room layout
        function jb_show_state(state) {
            const overlay = document.getElementById("overlay");
            const stateLabel = document.createElement("div");
            stateLabel.className = "state-label";
            stateLabel.innerText = state;

            // Position the label at the center of the layout
            stateLabel.style.left = '50%';
            stateLabel.style.top = '50%';

            overlay.appendChild(stateLabel);
        }
    </script>

</body>
</html>
